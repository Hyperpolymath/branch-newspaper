# SPDX-License-Identifier: AGPL-3.0-or-later
name: CI

on:
  push:
    branches: [main, master, develop]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions: read-all

env:
  MIX_ENV: test
  ELIXIR_VERSION: '1.15.7'
  OTP_VERSION: '26.2'

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-

      - name: Install dependencies
        run: |
          mix local.hex --force
          mix local.rebar --force
          mix deps.get

      - name: Run lint checks
        run: ./ci-scripts/lint.sh

  test:
    name: Test (Elixir ${{ matrix.elixir }} / OTP ${{ matrix.otp }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Primary supported version
          - elixir: '1.15.7'
            otp: '26.2'
          # Latest versions
          - elixir: '1.16.0'
            otp: '26.2'
          # Minimum supported version
          - elixir: '1.15.0'
            otp: '25.3'

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      - name: Cache deps
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-

      - name: Install dependencies
        run: |
          mix local.hex --force
          mix local.rebar --force
          mix deps.get

      - name: Setup test environment
        run: ./ci-scripts/setup.sh

      - name: Run tests
        run: ./ci-scripts/test.sh

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
    env:
      MIX_ENV: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-prod-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-prod-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-

      - name: Build release
        run: ./ci-scripts/build.sh

      - name: Upload release artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: branch-newspaper-release
          path: _build/prod/rel/branch_newspaper/
          if-no-files-found: warn

  mirror-to-gitlab:
    name: Mirror to GitLab
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup SSH for GitLab
        env:
          GITLAB_SSH_KEY: ${{ secrets.GITLAB_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$GITLAB_SSH_KEY" > ~/.ssh/gitlab_key
          chmod 600 ~/.ssh/gitlab_key
          ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
          cat >> ~/.ssh/config << EOF
          Host gitlab.com
            HostName gitlab.com
            User git
            IdentityFile ~/.ssh/gitlab_key
            StrictHostKeyChecking no
          EOF

      - name: Push to GitLab
        env:
          GITLAB_URL: git@gitlab.com:maa-framework/3-applications/branch-newspaper.git
        run: ./ci-scripts/mirror-push.sh
